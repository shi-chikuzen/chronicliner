<!DOCTYPE html>
<!-- Copyright (c) 2022 @shi_chikuzen-->
<html lang="ja" dir="ltr" id="html">
    <head>
        <meta charset="utf-8">
        <!-- Vuetify CDN Settings -->
        <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
        <!-- SheetJS CDN Settings -->
        <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
        <!-- moment.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <!-- lodash -->
        <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
        <!-- Font -->
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&family=Unica+One&display=swap" rel="stylesheet">
        <!-- Sourse -->
        <link rel="stylesheet" href="./css/app.css">

        <title>Chronicliner2</title>
    </head>
    <body>
        <div id="app">
            <v-app>
                <!-- Application Bar -->
                <v-app-bar
                app
                absolute
                class="px-10"
                style="border-bottom: 1px solid #eaf1f5 !important;"
                color="white"
                elevation="0">
                    <v-toolbar-title class="font logo">Chronicliner</v-toolbar-title>
                    <v-spacer></v-spacer>
                    <!-- File Form -->
                    <v-form>
                        <v-file-input
                        v-model="fileSelected"
                        @change="readFile"
                        accept=".xlsx"
                        label="Select File..."
                        hide-input
                        prepend-icon="mdi-folder-table-outline"
                        ></v-file-input>
                    </v-form>
                    <!-- ファイル追加時chipをアニメーションで表示 -->
                    <v-expand-x-transition>
                        <v-chip
                        v-show="this.state.ready"
                        v-if="this.fileSelected != null"
                        :color="this.state.fileError? 'error' : 'success'"
                        outlined>
                            {{this.fileSelected.name}}
                        </v-chip>
                    </v-expand-x-transition>
                </v-app-bar>
                <!-- Contents -->
                <v-main id="main">
                    <v-container fluid>
                        <v-row class="px-3">
                            <!-- Select Field -->
                            <v-col cols="12">
                                <v-expansion-panels accordion>
                                    <v-expansion-panel
                                    elevation="1">
                                        <v-expansion-panel-header class="size line-height">
                                            表示設定
                                        </v-expansion-panel-header>
                                        <v-expansion-panel-content>
                                            <v-tabs
                                            vertical
                                            v-show="this.state.ready">
                                                <v-tab
                                                v-for="(value, name) in this.data.settings.category"
                                                class="justify-start">
                                                    <span>{{name}}</span>
                                                </v-tab>
                                                <v-tab-item
                                                v-for="(value, name) in this.data.settings.category">
                                                    <v-card flat>
                                                        <v-card-text>
                                                            <v-row class="py-0">
                                                                <v-col class="py-0">
                                                                    <v-btn text @click="selectAllCharactersInCategory(name)">
                                                                        すべて選択
                                                                    </v-btn>
                                                                    <v-btn text @click="removeAllCharactersInCategory(name)">
                                                                        すべて選択解除
                                                                    </v-btn>
                                                                </v-col>
                                                            </v-row>
                                                            <v-row>
                                                                <v-col
                                                                v-for="character in value.characters">
                                                                    <v-checkbox
                                                                    v-model="characterSelected"
                                                                    :label="character"
                                                                    :value="character"
                                                                    ></v-checkbox>
                                                                </v-col>
                                                            </v-row>
                                                        </v-card-text>
                                                    </v-card>
                                                </v-tab-item>
                                            </v-tabs>
                                        </v-expansion-panel-content>
                                    </v-expansion-panel>
                                </v-expansion-panels>
                            </v-col>
                            <!-- Contents Field -->
                            <v-col cols="12">
                                <v-card
                                elevation="1"
                                :loading="this.state.loading"
                                :class="(this.state.ready) ? 'pb-4' : ''">
                                    <v-card-title class="px-6 size">
                                        年表{{this.characterNames}}
                                    </v-card-title>
                                    <v-card-text class="px-6" id="timelineParent">
                                        <v-expand-transition>
                                            <!-- Timeline Table -->
                                            <v-data-table
                                            id="timeline"
                                            ref="timeline"
                                            :headers="timelineHeaders"
                                            :items="timelineDataShow"
                                            disable-sort="true"
                                            class="elevation-0 overflow-y-auto"
                                            v-show="this.state.ready"
                                            calculate-widths="true"
                                            hide-default-footer
                                            :height="this.tableHeight"
                                            fixed-header
                                            :items-per-page="-1">
                                                <!-- Header（1行目） -->
                                                <template v-slot:header="props">
                                                    <thead>
                                                        <tr>
                                                            <th colspan="1" class="border-none"><!-- 年数列 --></th>
                                                            <template v-for="(category, name) in data.settings.category">
                                                                <th
                                                                v-show="intersection(category.characters, characterSelected).length > 0"
                                                                :colspan="intersection(category.characters, characterSelected).length * 2"
                                                                :style="'background-color: ' + category.color + '; border: thin solid white;'"
                                                                class="white--text">
                                                                    {{ name }}
                                                                </th>
                                                            </template>
                                                        </tr>
                                                    </thead>
                                                </template>
                                                <template v-slot:body="{items}">
                                                    <tr v-for="item in items">
                                                        <template v-for="column in timelineHeaders">
                                                            <!-- 年表示列 -->
                                                            <td
                                                            v-if="column.value == 'year'"
                                                            :class="column.cellClass.join(' ')">
                                                                <span v-show="item.isFirstEvent">
                                                                    <div class="d-flex flex-column align-content-center justify-center align-center">
                                                                        <div class="text-center font" style="font-size: 1.1em;">{{item.year}}</div>
                                                                        <v-btn
                                                                        class="ma-0"
                                                                        text
                                                                        icon
                                                                        color="primary"
                                                                        @click="toggleYearSummaryShow(item.year); update();">
                                                                            <v-icon v-if="yearSummary[item.year].show" class="size">
                                                                                mdi-plus
                                                                            </v-icon>
                                                                            <v-icon v-else class="size">
                                                                                mdi-minus
                                                                            </v-icon>
                                                                        </v-btn>
                                                                    </div>
                                                                </span>
                                                            </td>
                                                            <!-- タイムライン列 -->
                                                            <td
                                                            v-else-if="colsTL.indexOf(column.value) != -1"
                                                            :class="column.cellClass.join(' ')">
                                                                <v-tooltip right
                                                                :color="(item[column.value].age >= 0 && item[column.value].summary == false) ? '' : 'rgba(0,0,0,0)'">
                                                                    <template v-slot:activator="{ on, attrs }">
                                                                        <v-sheet
                                                                        height="100%"
                                                                        width="100%"
                                                                        v-bind="attrs"
                                                                        v-on="on"
                                                                        :color="returnTimelineColor(item[column.value])"
                                                                        :data-color="returnTimelineColor(item[column.value])"
                                                                        >
                                                                            <svg v-if="item[column.value].firstAfterDied" class="arrow-svg svgFill" :data-color="
                                                                            item[column.value].color" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 53.27 28.73"><defs><style>.cls-1{fill:#f7f9f7;}.cls-2{fill:none;stroke:#fff;stroke-linecap:round;stroke-miterlimit:10;stroke-width:4px;}</style></defs><g id="レイヤー_2" data-name="レイヤー 2"><g id="レイヤー_1-2" data-name="レイヤー 1"><polygon class="cls-1" points="26.49 26.73 1.72 0 51.27 0 26.49 26.73"/><line class="cls-2" x1="26.63" y1="26.73" x2="51.27" y2="2.09"/><line class="cls-2" x1="2" y1="2.09" x2="26.63" y2="26.73"/></g></g></svg>
                                                                            <img v-else-if="item[column.value].age > 0" v-show="item[column.value].needsArrow" src="./svg/nofill.svg" alt="" class="arrow-svg">
                                                                            <img v-else v-show="item[column.value].needsArrow" src="./svg/fill.svg" alt="" class="arrow-svg">
                                                                        </v-sheet>
                                                                    </template>
                                                                    <span>
                                                                        <v-row v-show="item[column.value].age >= 0 && item[column.value].summary == false">
                                                                            <v-col cols="3" class="d-flex align-center">
                                                                                <v-icon
                                                                                dark
                                                                                left>
                                                                                    mdi-information
                                                                                </v-icon>
                                                                            </v-col>
                                                                            <v-col cols="9">
                                                                                {{item[column.value].name}}
                                                                                <template>
                                                                                    <br>年齢:&nbsp;{{item[column.value].age}}<br>
                                                                                </template>
                                                                                <template v-if="'name' in item[column.value].school">
                                                                                    {{item[column.value].school.name}}:&nbsp;{{item[column.value].school.grade}}年
                                                                                </template>
                                                                            </v-col>
                                                                        </v-row>
                                                                    </span>
                                                                </v-tooltip>
                                                            </td>
                                                            <!-- イベントカード列 -->
                                                            <td
                                                            v-else-if="colsEV.indexOf(column.value) != -1"
                                                            :class="column.cellClass.join(' ')">
                                                                <v-row class="pa-0">
                                                                    <v-col cols="12">
                                                                        <v-card
                                                                        v-for="(event, index) in item[column.value]"
                                                                        :color="returnCardColor(event.category)"
                                                                        :class="returnCardClass(index, item[column.value])"
                                                                        outlined>
                                                                            <v-tooltip bottom
                                                                            :color="(event.detail === '') ? 'rgba(0, 0, 0, 0)' : ''">
                                                                                <template v-slot:activator="{ on, attrs }">
                                                                                    <v-card-text
                                                                                    v-bind:class="returnCardTextClass(event.category)"
                                                                                    class="pa-2"
                                                                                    v-bind="attrs"
                                                                                    v-on="on">
                                                                                        <v-row>
                                                                                            <v-col cols="4" v-if="item.displayLimit > 0 && event.category != 'summary'" class="font d-flex flex-column align-content-center align-center justify-center pr-0">
                                                                                                <div
                                                                                                style="font-size: 1.4rem;"
                                                                                                class="font text-center">
                                                                                                    {{item.date.getMonth() + 1}}
                                                                                                </div>
                                                                                                <div
                                                                                                v-if="item.displayLimit > 1"
                                                                                                class="font text-center pt-1">
                                                                                                    {{item.date.getDate()}}TH
                                                                                                </div>
                                                                                                <div
                                                                                                v-if="item.displayLimit > 2"
                                                                                                class="font text-center">
                                                                                                    {{fillTimeByZero(item.date.getHours())}}:{{fillTimeByZero(item.date.getMinutes())}}
                                                                                                </div>
                                                                                                <div v-if="item.beforeAfter != ''" class="text-center">
                                                                                                    {{item.beforeAfter}}
                                                                                                </div>
                                                                                            </v-col>
                                                                                            <v-col cols="" class="pa-3 d-flex flex-column align-content-center align-center justify-center">
                                                                                                <div class="text-center"
                                                                                                v-text="event.title" style="white-space: pre-line;">
                                                                                                </div>
                                                                                            </v-col>
                                                                                        </v-row>
                                                                                    </v-card-text>
                                                                                </template>
                                                                                <span v-if="event.detail != ''" v-text="event.detail" style="white-space: pre-line;"></span>
                                                                            </v-tooltip>
                                                                        </v-card>
                                                                    </v-col>
                                                                </v-row>
                                                            </td>
                                                        </template>
                                                    </tr>
                                                </template>
                                                <!-- 年齢列 -->
                                                <template v-slot:item.year="{ item }">
                                                    <span v-show="item.isFirstEvent">
                                                        <div class="d-flex flex-column align-content-center justify-center align-center">
                                                            <div class="text-center font" style="font-size: 1.1em;">{{item.year}}</div>
                                                            <v-btn
                                                            class="ma-0"
                                                            text
                                                            icon
                                                            color="primary"
                                                            @click="toggleYearSummaryShow(item.year); update();">
                                                                <v-icon v-if="yearSummary[item.year].show" class="size">
                                                                    mdi-plus
                                                                </v-icon>
                                                                <v-icon v-else class="size">
                                                                    mdi-minus
                                                                </v-icon>
                                                            </v-btn>
                                                        </div>
                                                    </span>
                                                </template>
                                                <!-- 矢印列 -->
                                                <template v-for="tlkey in colsTL" v-slot:[`item.${tlkey}`]="{ item }">
                                                    <v-tooltip right
                                                    :color="(item[tlkey].age >= 0 && item[tlkey].summary == false) ? '' : 'rgba(0,0,0,0)'">
                                                        <template v-slot:activator="{ on, attrs }">
                                                            <v-sheet
                                                            height="100%"
                                                            width="100%"
                                                            :color="returnTimelineColor(item[tlkey])"
                                                            :data-color="returnTimelineColor(item[tlkey])"
                                                            v-bind="attrs"
                                                            v-on="on">
                                                                <svg v-if="item[tlkey].firstAfterDied" class="arrow-svg svgFill" :data-color="
                                                                item[tlkey].color" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 53.27 28.73"><defs><style>.cls-1{fill:#f7f9f7;}.cls-2{fill:none;stroke:#fff;stroke-linecap:round;stroke-miterlimit:10;stroke-width:4px;}</style></defs><g id="レイヤー_2" data-name="レイヤー 2"><g id="レイヤー_1-2" data-name="レイヤー 1"><polygon class="cls-1" points="26.49 26.73 1.72 0 51.27 0 26.49 26.73"/><line class="cls-2" x1="26.63" y1="26.73" x2="51.27" y2="2.09"/><line class="cls-2" x1="2" y1="2.09" x2="26.63" y2="26.73"/></g></g></svg>
                                                                <img v-else-if="item[tlkey].age > 0" v-show="item[tlkey].needsArrow" src="./svg/nofill.svg" alt="" class="arrow-svg">
                                                                <img v-else v-show="item[tlkey].needsArrow" src="./svg/fill.svg" alt="" class="arrow-svg">
                                                            </v-sheet>
                                                        </template>
                                                        <span>
                                                            <v-row v-show="item[tlkey].age >= 0 && item[tlkey].summary == false">
                                                                <v-col cols="3" class="d-flex align-center">
                                                                    <v-icon
                                                                    dark
                                                                    left>
                                                                        mdi-information
                                                                    </v-icon>
                                                                </v-col>
                                                                <v-col cols="9">
                                                                    {{item[tlkey].name}}
                                                                    <template>
                                                                        <br>年齢:&nbsp;{{item[tlkey].age}}<br>
                                                                    </template>
                                                                    <template v-if="'name' in item[tlkey].school">
                                                                        {{item[tlkey].school.name}}:&nbsp;{{item[tlkey].school.grade}}年
                                                                    </template>
                                                                </v-col>
                                                            </v-row>
                                                        </span>
                                                    </v-tooltip>
                                                </template>
                                                <!-- データカード列 -->
                                                <template v-for="evkey in colsEV" v-slot:[`item.${evkey}`]="{ item }">
                                                    <v-row class="pa-0">
                                                        <v-col cols="12">
                                                            <v-card
                                                            v-for="(event, index) in item[evkey]"
                                                            :color="returnCardColor(event.category)"
                                                            :class="returnCardClass(index, item[evkey])"
                                                            outlined>
                                                                <v-tooltip bottom
                                                                :color="(event.detail === '') ? 'rgba(0, 0, 0, 0)' : ''">
                                                                    <template v-slot:activator="{ on, attrs }">
                                                                        <v-card-text
                                                                        v-bind:class="returnCardTextClass(event.category)"
                                                                        class="pa-2"
                                                                        v-bind="attrs"
                                                                        v-on="on">
                                                                            <v-row>
                                                                                <v-col cols="4" v-if="item.displayLimit > 0 && event.category != 'summary'" class="font d-flex flex-column align-content-center align-center justify-center pr-0">
                                                                                    <div
                                                                                    style="font-size: 1.4rem;"
                                                                                    class="font text-center">
                                                                                        {{item.date.getMonth() + 1}}
                                                                                    </div>
                                                                                    <div
                                                                                    v-if="item.displayLimit > 1"
                                                                                    class="font text-center pt-1">
                                                                                        {{item.date.getDate()}}TH
                                                                                    </div>
                                                                                    <div
                                                                                    v-if="item.displayLimit > 2"
                                                                                    class="font text-center">
                                                                                        {{fillTimeByZero(item.date.getHours())}}:{{fillTimeByZero(item.date.getMinutes())}}
                                                                                    </div>
                                                                                    <!-- {{item}} -->
                                                                                    <div v-if="item.beforeAfter != ''" class="text-center">
                                                                                        {{item.beforeAfter}}
                                                                                    </div>
                                                                                </v-col>
                                                                                <v-col cols="" class="pa-3 d-flex flex-column align-content-center align-center justify-center">
                                                                                    <div class="text-center"
                                                                                    v-text="event.title" style="white-space: pre-line;">
                                                                                    </div>
                                                                                </v-col>
                                                                            </v-row>
                                                                        </v-card-text>
                                                                    </template>
                                                                    <span v-if="event.detail != ''" v-text="event.detail" style="white-space: pre-line;"></span>
                                                                </v-tooltip>
                                                            </v-card>
                                                        </v-col>
                                                    </v-row>
                                                </template>
                                            </v-data-table>
                                        </v-expand-transition>
                                    </v-card-text>
                                </v-card>
                            </v-col>
                        </v-row>
                    </v-container>
                </v-main>
                <v-snackbar
                v-model="this.state.errorSnack"
                timeout=5000>
                    <span v-html="this.snackMessage"></span>
                    <template v-slot:action="{attrs}">
                        <v-btn
                        color="primary"
                        text
                        v-bind="attrs"
                        v-on:click="state.errorSnack = false;">
                            Close
                        </v-btn>
                    </template>
                </v-snackbar>
            </v-app>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
        <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
        <script type="text/javascript" src="./js/app.js"></script>
    </body>
</html>